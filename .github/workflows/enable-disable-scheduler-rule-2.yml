name: Toggle EventBridge Scheduler 2

on:
  workflow_dispatch:
    inputs:
      env:
        description: 'MÃ´i trÆ°á»ng (dev01, dev02)'
        required: true
        type: choice
        options:
          - dev01
          - dev02
      scheduler_name:
        description: 'TÃªn scheduler rule (khÃ´ng cáº§n prefix td-...)'
        required: true
      state:
        description: 'Tráº¡ng thÃ¡i muá»‘n chuyá»ƒn'
        required: true
        type: choice
        options:
          - ENABLED
          - DISABLED

jobs:
  toggle-scheduler:
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    env:
      AWS_REGION: ap-southeast-1

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials (assume role)
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::022269452713:role/GitHubActionsAthenaRole
          aws-region: ${{ env.AWS_REGION }}

      - name: Táº¡o tÃªn scheduler Ä‘áº§y Ä‘á»§
        id: create_scheduler_name
        run: |
          FULL_SCHEDULER_NAME="td-${{ github.event.inputs.env }}-${{ github.event.inputs.scheduler_name }}"
          echo "SCHEDULER_NAME=$FULL_SCHEDULER_NAME" >> $GITHUB_ENV
          echo "ðŸ”§ Scheduler Name: $FULL_SCHEDULER_NAME"

      - name: Kiá»ƒm tra scheduler tá»“n táº¡i
        id: check_schedule
        run: |
          echo "ðŸ” Kiá»ƒm tra scheduler '${SCHEDULER_NAME}'..."
          if aws scheduler get-schedule \
              --name "$SCHEDULER_NAME" \
              --group-name default \
              --region $AWS_REGION > current.json 2> err.log; then
            echo "âœ… Scheduler tá»“n táº¡i."
          else
            echo "âŒ Scheduler khÃ´ng tá»“n táº¡i!" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat err.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Kiá»ƒm tra tráº¡ng thÃ¡i hiá»‡n táº¡i cÃ³ trÃ¹ng input khÃ´ng
        id: state_check
        run: |
          CURRENT_STATE=$(jq -r .State current.json)
          echo "CURRENT_STATE=$CURRENT_STATE" >> $GITHUB_ENV
          
          if [ "$CURRENT_STATE" == "${{ github.event.inputs.state }}" ]; then
            echo "SKIP_UPDATE=true" >> $GITHUB_ENV
            echo "âš ï¸ Scheduler Ä‘Ã£ á»Ÿ tráº¡ng thÃ¡i '${{ github.event.inputs.state }}', khÃ´ng cáº§n cáº­p nháº­t." >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "SKIP_UPDATE=false" >> $GITHUB_ENV
          fi

      - name: Chuáº©n bá»‹ dá»¯ liá»‡u scheduler hiá»‡n táº¡i
        if: env.SKIP_UPDATE == 'false'
        run: |
          SCHEDULE_EXPRESSION=$(jq -r .ScheduleExpression current.json)
          FLEXIBLE_WINDOW=$(jq -c .FlexibleTimeWindow current.json)
          TARGET=$(jq -c .Target current.json)

          echo "$FLEXIBLE_WINDOW" > fw.json
          echo "$TARGET" > target.json
          echo "SCHEDULE_EXPRESSION=$SCHEDULE_EXPRESSION" >> $GITHUB_ENV

      - name: Cáº­p nháº­t tráº¡ng thÃ¡i scheduler
        if: env.SKIP_UPDATE == 'false'
        run: |
          echo "âš™ï¸ Äang chuyá»ƒn scheduler '${SCHEDULER_NAME}' sang tráº¡ng thÃ¡i '${{ github.event.inputs.state }}'..."
          if aws scheduler update-schedule \
              --name "$SCHEDULER_NAME" \
              --group-name default \
              --schedule-expression "$SCHEDULE_EXPRESSION" \
              --flexible-time-window file://fw.json \
              --target file://target.json \
              --state "${{ github.event.inputs.state }}" \
              --region $AWS_REGION > update_success.json 2> update_error.log; then
            echo "âœ… Scheduler '$SCHEDULER_NAME' Ä‘Ã£ chuyá»ƒn sang tráº¡ng thÃ¡i '${{ github.event.inputs.state }}'." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Lá»—i khi cáº­p nháº­t tráº¡ng thÃ¡i scheduler!" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat update_error.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
