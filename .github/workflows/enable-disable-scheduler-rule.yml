name: Toggle EventBridge Scheduler

on:
  workflow_dispatch:
    inputs:
      scheduler_name:
        description: 'TÃªn scheduler rule (group: default)'
        required: true
      state:
        description: 'Tráº¡ng thÃ¡i muá»‘n chuyá»ƒn'
        required: true
        type: choice
        options:
          - ENABLED
          - DISABLED

jobs:
  toggle-scheduler:
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    env:
      AWS_REGION: ap-southeast-1

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials (assume role)
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::022269452713:role/GitHubActionsAthenaRole
          aws-region: ap-southeast-1

      - name: Kiá»ƒm tra scheduler tá»“n táº¡i
        id: check_schedule
        run: |
          echo "ðŸ” Kiá»ƒm tra scheduler '${{ github.event.inputs.scheduler_name }}'..."
          if aws scheduler get-schedule \
              --name "${{ github.event.inputs.scheduler_name }}" \
              --group-name default \
              --region $AWS_REGION > current.json 2> err.log; then
            echo "âœ… Scheduler tá»“n táº¡i."
          else
            echo "âŒ Scheduler khÃ´ng tá»“n táº¡i!" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat err.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Chuáº©n bá»‹ dá»¯ liá»‡u scheduler hiá»‡n táº¡i
        run: |
          SCHEDULE_EXPRESSION=$(jq -r .ScheduleExpression current.json)
          FLEXIBLE_WINDOW=$(jq -c .FlexibleTimeWindow current.json)
          TARGET=$(jq -c .Target current.json)

          echo "$FLEXIBLE_WINDOW" > fw.json
          echo "$TARGET" > target.json
          echo "SCHEDULE_EXPRESSION=$SCHEDULE_EXPRESSION" >> $GITHUB_ENV

      - name: Cáº­p nháº­t tráº¡ng thÃ¡i scheduler
        run: |
          echo "âš™ï¸ Äang chuyá»ƒn scheduler '${{ github.event.inputs.scheduler_name }}' sang tráº¡ng thÃ¡i '${{ github.event.inputs.state }}'..."
          if aws scheduler update-schedule \
              --name "${{ github.event.inputs.scheduler_name }}" \
              --group-name default \
              --schedule-expression "$SCHEDULE_EXPRESSION" \
              --flexible-time-window file://fw.json \
              --target file://target.json \
              --state "${{ github.event.inputs.state }}" \
              --region $AWS_REGION > update_success.json 2> update_error.log; then
            echo "âœ… Scheduler '${{ github.event.inputs.scheduler_name }}' Ä‘Ã£ chuyá»ƒn sang tráº¡ng thÃ¡i '${{ github.event.inputs.state }}'." >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat update_success.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Lá»—i khi cáº­p nháº­t tráº¡ng thÃ¡i scheduler!" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat update_error.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
